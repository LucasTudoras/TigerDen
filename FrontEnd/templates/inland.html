{% extends "loggedin.html" %}

{% block content %}    
    <div class="logoutContainer">
        <a href="/logout" class="loginButton">Log Out</a>
    </div>

    <div class="search-text">
    <h2>Search for Rooms</h2>
    Filter a search query to find the rooms that fit your desires.
    </div>
    <div class="search-options-container">
        <form action="/login" onsubmit="saveFilterSelection()" class="checkbox-options-container" method="POST">
            <div class="search-group">
                {% for option in ['Butler', 'Forbes', 'Mathey', 'New College West', 'Rocky', 'Upperclass', 'Whitman', 'Yeh'] %}
                <div class="checkbox-item"><label>
                    <input type="checkbox" name="CollegeOptions" value="{{ option }}"
                            {% if option in user_data['selected_colleges'] %} checked {% endif %}>
                    {{ option }}
                </label></div><br>
                {% endfor %}
                <button onclick="selectAllColleges()">Select All Colleges</button>
                <button onclick="deselectAllColleges()">Deselect All Colleges</button>
            </div>

            <div class="search-group">
            {% for option in ['Single', 'Double', 'Triple', 'Quad', 'Quint', '6-Person'] %}
                <div class="checkbox-item"><label>
                    <input type="checkbox" name="TypeOptions" value="{{ option }}"
                            {% if option in user_data['selected_types'] %} checked {% endif %}>
                    {{ option }}
                </label></div><br>
            {% endfor %}

            <button onclick="selectAllTypes()">Select All Room Types</button>
            <button onclick="deselectAllTypes()">Deselect All Room Types</button>
            <button onclick="fetchCheckedTypes()" type="submit">Filter</button>

            </div>
        </form>
        
        
        <form action="/login" method="GET">
            <div class="search-group">

                <h4 style="display: inline;">Sort by</h4>
                <label for="FirstSort"></label>
                <select name="FirstSort" id="FirstSort" onchange="sendSelectedValue1()">
                    <option value="Hall" {% if user_data.FirstSort == "Hall" %}selected{% endif %}>Hall</option>
                    <option value="Room" {% if user_data.FirstSort == "Room" %}selected{% endif %}>Room Number</option>
                    <option value="Type" {% if user_data.FirstSort == "Type" %}selected{% endif %}>Type</option>
                    <option value="Sqft" {% if user_data.FirstSort == "Sqft" %}selected{% endif %}>Size</option>
                    <option value="College" {% if user_data.FirstSort == "College" %}selected{% endif %}>College</option>
                    <option value="Region" {% if user_data.FirstSort == "Region" %}selected{% endif %}>Region</option>
                </select>
                <select name="FirstOrder" id="FirstOrder" onchange="sendOrder2()">
                    <option value="ASC" {% if user_data.FirstOrder == "ASC" %}selected{% endif %}>Ascending</option>
                    <option value="DESC" {% if user_data.FirstOrder == "DESC" %}selected{% endif %}>Descending</option>
                </select>

                <label for="SecondSort"></label>
                <select name="SecondSort" id="SecondSort" onchange="sendSelectedValue2()">
                    <option value="Hall" {% if user_data.SecondSort == "Hall" %}selected{% endif %}>Hall</option>
                    <option value="Room" {% if user_data.SecondSort == "Room" %}selected{% endif %}>Room Number</option>
                    <option value="Type" {% if user_data.SecondSort == "Type" %}selected{% endif %}>Type</option>
                    <option value="Sqft" {% if user_data.SecondSort == "Sqft" %}selected{% endif %}>Size</option>
                    <option value="College" {% if user_data.SecondSort == "College" %}selected{% endif %}>College</option>
                    <option value="Region" {% if user_data.SecondSort == "Region" %}selected{% endif %}>Region</option>
                </select>
                <select name="SecondOrder" id="SecondOrder" onchange="sendOrder2()">
                    <option value="ASC" {% if user_data.SecondOrder == "ASC" %}selected{% endif %}>Ascending</option>
                    <option value="DESC" {% if user_data.SecondOrder == "DESC" %}selected{% endif %}>Descending</option>
                </select>
                
                <button type="submit">Search</button>
            </div>
        </form>
    </div>

    <div class="search-text">
        <h2 style="display: inline;">Room Search Results</h2>
    </div>

    {% if results %}
    <div class="table-container"><table id="room results" border="1">
        <tr>
            <td><strong>Hall</strong></td>
            <td><strong>Room</strong></td>
            <td><strong>Type</strong></td>
            <td><strong>Sqft</strong></td>
            <td><strong>College</strong></td>
            <td><strong>Region</strong></td>
            <td><strong>Floor Plan</strong></td>
            <td><strong>More Info</strong></td>
        </tr>

        {% for room in results %}
        <tr>
            <td align="center" class="special">{{ room['Hall'] }}</td>
            <td align="center" class="special">{{ room['Room'] }}</td>
            <td align="center" class="special">{{ room['Type'] }}</td>
            <td align="center" class="special">{{ room['Sqft'] }}</td>
            <td align="center" class="special">{{ room['College'] }}</td>
            <td align="center" class="special">{{ room['Region'] }}</td>
            <td align="center" class="special">
                {% if room['FilePath'] %}
                    <a href="{{ url_for('static', filename=room['FilePath']) }}" target="_blank">View Floor Plan</a>
                {% else %}
                    N/A
                {% endif %}
            </td>
            <td class="special"><a href="/room_details/{{ room['RoomID'] }}">Click here to see more</a></td>
        </tr>
        {% endfor %}
    </table></div>
    {% else %}
        <p>No rooms found matching your criteria.</p>
    {% endif %}


<script>
function getCookies() {
const cookies = document.cookie.split('; ').reduce((acc, cookie) => {
    const [key, value] = cookie.split('=');
    acc[key] = decodeURIComponent(value);
    return acc;
}, {});

return cookies;
}

function sendSelectedValue1() {
    const selectedValue1 = document.getElementById("FirstSort").value;
    fetch(`/get_selected_value?selectedValue1=${encodeURIComponent(selectedValue1)}`)
    .then(response => response.json())
}

function sendSelectedValue2() {
    const selectedValue2 = document.getElementById("SecondSort").value;
    fetch(`/get_selected_value?selectedValue2=${encodeURIComponent(selectedValue2)}`)
    .then(response => response.json())
}

function sendOrder1() {
    const selectedOrder1 = document.getElementById("FirstOrder").value;
    fetch(`/get_order?selectedOrder1=${encodeURIComponent(selectedOrder1)}`)
    .then(response => response.json())
}

function sendOrder2() {
    const selectedOrder2 = document.getElementById("SecondOrder").value;
    fetch(`/get_order?selectedOrder2=${encodeURIComponent(selectedOrder2)}`)
    .then(response => response.json())
}



function fetchCheckedColleges() {
    console.log("Filter button clicked!");
    const checkboxes = document.querySelectorAll('input[name="CollegeOptions"]:checked');
    const selectedValues = Array.from(checkboxes).map(checkbox => checkbox.value);
    const firstSort = document.getElementById("FirstSort").value;
    const secondSort = document.getElementById("SecondSort").value;
    const firstOrder = document.getElementById("FirstOrder").value;
    const secondOrder = document.getElementById("SecondOrder").value;
    fetch('/apply-colleges', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            selectedOptions: selectedValues,
            FirstSort: firstSort,
            SecondSort: secondSort,
            FirstOrder: firstOrder,
            SecondOrder: secondOrder
        })
    })
    .then(response => response.json())
    .then(data => {
    document.getElementById('results').innerHTML = data.results;
    })
    .catch(error => console.error('Error:', error));
}

function fetchCheckedTypes() {
    console.log("Filter button clicked!");
    const checkboxes = document.querySelectorAll('input[name="TypeOptions"]:checked');
    const selectedValues = Array.from(checkboxes).map(checkbox => checkbox.value);
    const firstSort = document.getElementById("FirstSort").value;
    const secondSort = document.getElementById("SecondSort").value;
    const firstOrder = document.getElementById("FirstOrder").value;
    const secondOrder = document.getElementById("SecondOrder").value;
    fetch('/apply-types', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            selectedOptions: selectedValues,
            FirstSort: firstSort,
            SecondSort: secondSort,
            FirstOrder: firstOrder,
            SecondOrder: secondOrder
        })
    })
    .then(response => response.json())
    .then(data => {
    document.getElementById('results').innerHTML = data.results;
    })
    .catch(error => console.error('Error:', error));
}

function selectAllColleges() {
    console.log("Select All button clicked")
    document.querySelectorAll('input[name="CollegeOptions"]').forEach(checkbox => {
        try {
        checkbox.checked = true;
    } catch (error) {
        console.error("Error setting checkbox:", error);
    }
    });
    fetchFilters();
}

function deselectAllColleges() {
    document.querySelectorAll('input[name="CollegeOptions"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    fetchFilters();
}

function selectAllTypes() {
    document.querySelectorAll('input[name="TypeOptions"]').forEach(checkbox => {
        try {
        checkbox.checked = true;
    } catch (error) {
        console.error("Error setting checkbox:", error);
    }
    });
    fetchFilters();
}


function deselectAllTypes() {
    document.querySelectorAll('input[name="TypeOptions"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    fetchFilters();
}






function saveFilterSelection() {
    const collegeOptions = Array.from(document.querySelectorAll('input[name="CollegeOptions"]:checked'))
        .map(checkbox => checkbox.value);
    console.log(collegeOptions);
    document.cookie = `selected_colleges=${collegeOptions.join(',')}; path=/`;

    const typeOptions = Array.from(document.querySelectorAll('input[name="TypeOptions"]:checked'))
        .map(checkbox => checkbox.value);
    document.cookie = `selected_types=${typeOptions.join(',')}; path=/`;
}

function loadFilterSelection() {
    const cookies = document.cookie.split(';').reduce((acc, cookie) => {
        const [key, value] = cookie.split('=');
        acc[key.trim()] = decodeURIComponent(value);
        return acc;
    }, {});

    if (cookies.selected_colleges) {
        const selectedColleges = cookies.selected_colleges.split(',');
        document.querySelectorAll('input[name="CollegeOptions"]').forEach(checkbox => {
            checkbox.checked = selectedColleges.includes(checkbox.value);
        });
    }

    if (cookies.selected_types) {
        const selectedTypes = cookies.selected_types.split(',');
        document.querySelectorAll('input[name="TypeOptions"]').forEach(checkbox => {
            checkbox.checked = selectedTypes.includes(checkbox.value);
        });
    }
}

document.addEventListener('DOMContentLoaded', loadFilterSelection);


</script>
{% endblock %}